parameters:
- name: checkoutRepo
  type: string
  default: 'self'
- name: checkoutRef
  type: string
  default: ''
- name: aptPackages
  type: object
  default:
    - cmake
    - libdrm-amdgpu-dev
    - libdrm-dev
    - python3-pip
- name: rocmDependencies
  type: object
  default:
    - ROCR-Runtime
    - rocprofiler-register
- name: rocmTestDependencies
  type: object
  default:
    - ROCR-Runtime
    - rocprofiler-register

- name: compileTimeMatrix
  type: object
  default:
    testList:
      - gfx942:
        target: gfx942
        conditions:
          - eq(variables.ENABLE_GFX942_TESTS, 'true')
          - not(containsValue(split(variables.DISABLED_GFX942_TESTS, ','), variables['Build.DefinitionName']))
      - gfx90a:
        target: gfx90a
        conditions:
          - eq(variables.ENABLE_GFX90A_TESTS, 'true')
          - not(containsValue(split(variables.DISABLED_GFX90A_TESTS, ','), variables['Build.DefinitionName']))

jobs:
- job: rocminfo_build_all
  variables:
  - group: common
  - template: /.azuredevops/variables-global.yml
  pool: 
    vmImage: ${{ variables.BASE_BUILD_POOL }}
  workspace:
    clean: all
  steps:
  - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/dependencies-other.yml
    parameters:
      aptPackages: ${{ parameters.aptPackages }}
      registerROCmPackages: true
  - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/preamble.yml
  - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/checkout.yml
    parameters:
      checkoutRepo: ${{ parameters.checkoutRepo }}
  - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/dependencies-rocm.yml
    parameters:
      checkoutRef: ${{ parameters.checkoutRef }}
      dependencyList: ${{ parameters.rocmDependencies }}
      skipLlvmSymlink: true
  - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/build-cmake.yml
    parameters:
      extraBuildFlags: >-
        -DCMAKE_PREFIX_PATH=$(Agent.BuildDirectory)/rocm
        -DROCRTST_BLD_TYPE=release
  - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/manifest.yml
  - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/artifact-upload.yml
  - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/artifact-links.yml

- ${{ each testJob in parameters.compileTimeMatrix.testList }}:
  - job: rocminfo_test_${{ testJob.target }}
    dependsOn: rocminfo_build_all
    condition: and(succeeded(), eq(variables['ENABLE_${{ upper(testJob.target) }}_TESTS'], 'true'), not(containsValue(split(variables['DISABLED_${{ upper(testJob.target) }}_TESTS'], ','), variables['Build.DefinitionName'])))
    variables:
    - group: common
    - template: /.azuredevops/variables-global.yml
    pool: ${{ testJob.target }}_test_pool
    workspace:
      clean: all
    steps:
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/dependencies-other.yml
      parameters:
        aptPackages: ${{ parameters.aptPackages }}
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/preamble.yml
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/local-artifact-download.yml
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/dependencies-rocm.yml
      parameters:
        checkoutRef: ${{ parameters.checkoutRef }}
        dependencyList: ${{ parameters.rocmTestDependencies }}
        gpuTarget: ${{ testJob.target }}
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/gpu-diagnostics.yml
      parameters:
        runRocminfo: false
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/test.yml
      parameters:
        componentName: rocminfo
        testDir: '$(Agent.BuildDirectory)'
        testExecutable: './rocm/bin/rocminfo'
        testParameters: ''
        testPublishResults: false
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/test.yml
      parameters:
        componentName: rocm_agent_enumerator
        testDir: '$(Agent.BuildDirectory)'
        testExecutable: './rocm/bin/rocm_agent_enumerator'
        testParameters: ''
        testPublishResults: false
    - template: ${{ variables.CI_TEMPLATE_PATH }}/steps/docker-container.yml
      parameters:
        aptPackages: ${{ parameters.aptPackages }}
        registerROCmPackages: true
        environment: test
        gpuTarget: ${{ testJob.target }}
